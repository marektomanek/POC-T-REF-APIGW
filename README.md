# Api Gateway Service

This is example of api gateway service created for educational purposes. The gateway provides single point of access to all other services. After initial authentication a JWT token is created based on user rights and roles configured in remote ANAT/LDAP service. The token is returned to the FE (front-end) application and used for all following api calls.

## Getting Started with local dev/test system

These instructions will get you a copy of the project up and running on your local machine for development and testing purposes.

### Prerequisites

Implementation requires Nodejs and NPM

### Installing

* Clone repository from [Github](https://github.com/JiriHusak-lab/POC-T-REF-APIGW)
* Run npm install (to get all dependencies).
* Run npm start

#### Local Dev environment

Dev and test mode is not using docker. It can be started by  **npm run localDev** command that enables hot-reloading.
Local dev mode comes with following features and limitation: 
* Ability to generate/mock JWT token without dependency on remote ANAT/LDAP service
* Four hardcoded identities mocking real LDAP registry (/mockData)

For local dev modes the system uses .env in the root directory of the project (see bellow environment vars. section)

#### Testing

Postman or curl:
* Call POST on localhost:3000/login with body {"name":"janko", "password":"janko"}. other test data are in /mockData dir.
* Expected result is: 

{
    "status": 200,
    "statusCase": "ok",
    "msg": "authentication done",
    "id": "j1",
    "name": "janko",
    "email": "janko@ok.ok",
    "role": [
        "manager"
    ],
    "token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJyb2xlcyI6WyJtYW5hZ2VyIl0sImlhdCI6MTU3ODMwNTAzOSwiZXhwIjoxNTc4MzkxNDM5LCJpc3MiOiJsb2NhbGhvc3QiLCJzdWIiOiJqYW5rb0Bvay5vayJ9.keyoWPDcdux5AsRuK8RZqhMMLHGYoda1Pl8MPp0iwua9Jxhm8DlQK4WHgzxDgkeeN1QPr9V3yoNiMEhCgDyCqw"
}

* For all subsequent request token must be presented in header **ibm-sec-token**. 
* Token validity test is possible on GET endpoint localhost:3000/login/verify, with no parameter and the sec. hedear.
* All proxied services also require sec. token. e.g. GET endpoint localhost:3000/gateway/mms?kmat=hraskoa

### Environment Variables
There are numerous bootstrap and configuration variables that must be available to properly run the service:
* VERSION=1.0.0 (Arbitrary value)
* RUNTIME_MODE=localDev (Supported modes are localDev, cloud, container)

* CLIENT_ID=aclient (Organization unit for LDAP queries)

* APP_ANAT_SHOULD_USE_MOCK=true (true/false for using mock or remote ANAT/LDAP service). In case of true a JWT token is generated by the gateway and there is no need to use/connect to remote ldap service (intented for easy local dev or simple testing)
* APP_ANAT_URL=e.g. 'http://localhost:3005/login' (if previous entry is true, than defines remote endpoint for ANAT/LDAP service)
* APP_ANAT_HOST='localhost' (Hostname of ANAT/LDAP service for JWG signing and verification)
* APP_ANAT_TOKEN_EXP='30s' (Time duration/expiration of generated JWT token, only applicable for mock mode)

APP_COCO_URL='https://coco-jirihusak-cz.trineckezelezarn-157683-f72ef11f3ab089a8c677044eb28292cd-0001.us-east.containers.appdomain.cloud/'
APP_COCO_GET_PATH=coco

* APP_JOURNAL_URL='xxx' (remote URL for material journal app)
* APP_JOURNAL_GET_PATH=yyy

* APP_MATERIAL_URL='xxx'
* APP_MATERIAL_GET_PATH=yyy
* APP_MATERIAL_PUT_PATH=zzz

## To be implemented pieces
gatewayRouter.js: router.put(........)
anat_shared_services.js: const doRemoteLogin = async (data) => {